const fs = require("fs");
const path = require("path");

const distDir = path.join(__dirname, "../dist");
const indexDtsPath = path.join(distDir, "index.d.ts");
const componentIndexDtsPath = path.join(distDir, "components/imageEditor/index.d.ts");

// Wait for the component index.d.ts to be generated
function waitForFile(filePath, maxAttempts = 10, delay = 500) {
  return new Promise((resolve, reject) => {
    let attempts = 0;
    
    const checkFile = () => {
      attempts++;
      if (fs.existsSync(filePath)) {
        resolve(true);
      } else if (attempts >= maxAttempts) {
        reject(new Error(`File ${filePath} was not created after ${maxAttempts} attempts`));
      } else {
        setTimeout(checkFile, delay);
      }
    };
    
    checkFile();
  });
}

async function generateIndexDts() {
  try {
    // Wait for the component index.d.ts to be generated by rollup
    await waitForFile(componentIndexDtsPath);
    
    // Read the component index.d.ts to understand the exports
    const componentIndexContent = fs.readFileSync(componentIndexDtsPath, "utf8");
    
    // Create the root index.d.ts file that re-exports everything
    const indexDtsContent = `export { default as ImageEditor } from "./components/imageEditor/ImageEditor";
export type { IImageEditorProps } from "./components/imageEditor/ImageEditor";
export type { CustomFabricObject, CustomFabricImage, CustomFabricPath, FabricSelectionEvent, ImageEditorCustomization, } from "./components/imageEditor/types";
`;

    // Ensure dist directory exists
    if (!fs.existsSync(distDir)) {
      fs.mkdirSync(distDir, { recursive: true });
    }

    // Write the index.d.ts file
    fs.writeFileSync(indexDtsPath, indexDtsContent, "utf8");
    
    console.log(`âœ… Generated ${indexDtsPath}`);
  } catch (error) {
    console.error("Error generating index.d.ts:", error);
    process.exit(1);
  }
}

generateIndexDts();

